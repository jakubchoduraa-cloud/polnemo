generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum City {
  Gdansk
  Gdynia
  Sopot
}

enum PropertyType {
  condo
  apartment
  house
  villa
}

enum PropertyStatus {
  draft
  published
  archived
}

enum ConciergeStatus {
  new
  in_progress
  resolved
}

enum SubscriptionStatus {
  INACTIVE
  ACTIVE
  PAST_DUE
  CANCELED
}

model User {
  id                 String             @id @default(cuid())
  name               String?
  email              String?            @unique
  emailVerified      DateTime?
  image              String?
  stripeCustomerId   String?            @unique
  stripeSubscriptionId String?
  subscriptionStatus SubscriptionStatus @default(INACTIVE)
  accounts           Account[]
  sessions           Session[]
  conciergeRequests  ConciergeRequest[]
  auditEvents        AuditEvent[]
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Property {
  id                       String         @id @default(cuid())
  slug                     String         @unique
  title                    String
  city                     City
  neighborhood             String?
  propertyType             PropertyType
  areaM2                   Float
  bedrooms                 Int
  bathrooms                Int
  yieldEstimate            Float?
  rentPotentialNotes       String?
  photos                   String[]
  descriptionShort         String
  descriptionLong          String
  travelTimePlaneHours     Float?
  travelTimeTrainHours     Float?
  airportTravelTimeMin     Int?
  riskFlagsJson            Json?
  sourceName               String
  sourceUrl                String
  sourceLastSeenAt         DateTime?
  projectId                String?
  developerId              String?
  status                   PropertyStatus @default(draft)
  isTopPick                Boolean        @default(false)
  publishedAt              DateTime?
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  project                  Project?       @relation(fields: [projectId], references: [id])
  developer                Developer?     @relation(fields: [developerId], references: [id])
  conciergeRequests        ConciergeRequest[]

  @@index([city, propertyType, status])
  @@index([publishedAt])
}

model Project {
  id                      String     @id @default(cuid())
  slug                    String     @unique
  name                    String
  city                    City
  developerId             String?
  unitsTotal              Int
  unitsForSale            Int
  publicPriceRangeMinCzk  Int
  publicPriceRangeMaxCzk  Int
  description             String
  locationNotes           String?
  createdAt               DateTime   @default(now())
  updatedAt               DateTime   @updatedAt
  developer               Developer? @relation(fields: [developerId], references: [id])
  properties              Property[]
}

model Developer {
  id            String     @id @default(cuid())
  slug          String     @unique
  name          String
  websiteUrl    String
  contactEmail  String?
  description   String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  projects      Project[]
  properties    Property[]
}

model LocalityStats {
  id                      String   @id @default(cuid())
  city                    City     @unique
  publicPriceRangeMinCzk  Int
  publicPriceRangeMaxCzk  Int
  updatedAt               DateTime @default(now())
  notes                   String?
}

model BlogPost {
  id            String    @id @default(cuid())
  slug          String
  lang          String
  title         String
  excerpt       String
  contentMd     String
  publishedAt   DateTime?
  seoTitle      String?
  seoDescription String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([slug, lang])
  @@index([lang, publishedAt])
}

model Lead {
  id        String    @id @default(cuid())
  name      String
  email     String
  phone     String?
  lang      String
  source    String
  createdAt DateTime  @default(now())
  conciergeRequests ConciergeRequest[]
}

model ConciergeRequest {
  id         String          @id @default(cuid())
  userId     String?
  leadId     String?
  propertyId String?
  message    String
  status     ConciergeStatus @default(new)
  createdAt  DateTime        @default(now())
  user       User?           @relation(fields: [userId], references: [id])
  lead       Lead?           @relation(fields: [leadId], references: [id])
  property   Property?       @relation(fields: [propertyId], references: [id])
}

model SubscriptionEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  payloadJson   Json
  createdAt     DateTime @default(now())
}

model FxRateDaily {
  id            String   @id @default(cuid())
  date          DateTime @unique
  plnToCzkRate  Float
  source        String   @default("CNB")
  createdAt     DateTime @default(now())
}

model AuditEvent {
  id          String   @id @default(cuid())
  actorUserId String?
  entityType  String
  entityId    String
  action      String
  diffJson    Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation(fields: [actorUserId], references: [id])
}
